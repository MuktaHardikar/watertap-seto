Photovoltaic-Battery Surrogate Model
=================================

This Photovoltaic-Battery unit model is a hybrid model that combines the Photovoltaic (PV) unit model with a battery storage system. 
The unit model is a surrogate model that inherits its base model structure from the `Solar Energy Base Model <https://watertap.readthedocs.io/en/latest/technical_reference/unit_models/energy_models/solar_energy_base.html>`_.
The model is trained using the data generated by the PV-Battery model from `PySAM <https://nrel-pysam.readthedocs.io/en/main/>`_ which is is a Python package for the National Renewable Energy Laboratory's `System Advisor Model (SAM) <https://sam.nrel.gov>`_.
The unit model supports steady state only.


Degrees of Freedom
------------------
The PV-Battery surrogate model degrees of freedom depends on the number of input labels defined by the user during data generation. The model includes at least 1 degree of freedom
for the system capacity. By default, the model includes the following input labels:

.. csv-table::
   :header: "Variable", "Variable Name","Symbol", "Units", "Description"

   "System Capacity", "`system_capacity`", ":math:`S_{capacity}`", ":math:`\text{kW}`", "Thermal power output of the system"
   "Hours of Storage", "`hours_storage`", ":math:`h_{storage}`", ":math:`\text{h}`", "Number of hours of thermal storage"
   "Battery Power", "`battery_power`", ":math:`P_{battery}`", ":math:`\text{kW}`", "Power output of the battery"

Users can choose to use a fixed value for the hours of storage or battery power when generating data using PySAM.

Generating Data
---------------

The data for the surrogate model can be generated using the `generate_pv_battery_data` function in `run_pysam_pv_battery.py` in the REFLO package.
The default weather file is already included in the REFLO package.
Weather specific to the user's location can be downloaded from the `National Solar Radiation Database <https://nsrdb.nrel.gov/data-viewer>`_.   
The `generate_pv_battery_data` function takes the following arguments:

.. csv-table::
   :header: "Variable", "Variable Name", "Units", "Description"

   "System capacity", "``system_capacities``", ":math:`\text{kW}`", "List of range of values of interest for the PV system capacity"
   "Hours of storage", "``hours_storage``", ":math:`\text{h}`", "List of range of values of interest for the hours of thermal storage"
   "Battery power", "``battery_power``", ":math:`\text{kW}`", "List of range of values of interest for the battery power"
   "Weather file", "``weather_file``", "", "Path to the weather file"
   "Dataset file name", "``dataset_filename``", "", "Name of the output dataset file"

Users can update the weather file for their specific location of interest by updating the file to variable ``default_weather_file``.
The `generate_pv_battery_data` function will generate the necessary data files (.pkl or .csv) for the surrogate model.

Variables
---------

The default outputs labels for the data generated using PySAM and the PV-battery surrogate model are:

.. csv-table::
   :header:  "Variable", "Variable Name", "Symbol", "Unit", "Description"

   "Electricity Annual", "``electricity_annual``", ":math:`E_{annual}`", ":math:`\text{kWh}`", "Annual electricity demand of the system"
   "Land Required", "``land_req``", ":math:`A_{land}`", ":math:`\text{acre}`", "Ratio of the system's annual DC output to the DC output if it operated at system capacity over the year"
   "Total AC Inverter Capacity", "``total_ac_capacity``", ":math:`C_{total, ac\_inverter}`", ":math:`\text{kW}`", "Total AC inverter capacity of the system"
   "Total DC Inverter Capacity", "``total_dc_inverter_capacity``", ":math:`C_{total, dc\_inverter}`", ":math:`\text{kWh}`", "Total DC inverter capacity of the system"

Relevant output labels are used to cost the PV system.


Model Structure
---------------

Additional parameters included in the PV-battery surrogate model are defined as follows:

.. csv-table::
   :header: "Parameter", "Parameter Name", "Symbol", "Valid Range", "Units"

   "Single Inverter Capacity", "``single_inverter_capacity``", ":math:`Capacity_{single-inverter}`", "2507.2", ":math:`\text{kW}`"
   "DC to AC ratio", "``DC_to_AC_ratio``", ":math:`DC/AC Ratio`", "1.2", ""


The parameters are used to calculate the land area required for the PV system.

.. math::

   \text{Inverter Capacity} = \frac{\text{System Capacity}}{\text{DC/AC Ratio}}



Costing
---------

The PV-battery surrogate model costing is implemented through the Energy Costing Package and calculates both capital and operating costs for the PV-battery system.
The costing methodology is based on the SAM PV-Battery model costing.

The capital cost for the PV-battery system is calculated as follows:

.. math::

   C_{total} = C_{direct} + C_{indirect} + C_{sales\_tax}


The direct cost components of the capital cost include the direct costs of PV and battery and are calculated as follows: 

.. math::

   C_{direct} = C_{pv\_direct} + C_{battery\_direct}

.. math::

   C_{pv\_direct} = (CF_{pv\_watt} + CF_{pv\_other\_watt}) \times Capacity_{system} + C_{inverter} \times CF_{inverter\_watt}

.. math::

   C_{battery\_direct} = CF_{battery,kwh} \times P_{battery} \times h_{storage}  + CF_{battery,kw} \times P_{battery}


The indirect cost components of the capital cost include indirect cost of PV and cost of land and is calculated as follows: 

   C_{indirect} = C_{pv, indirect} + C_{land}

.. math::

   C_{pv, indirect} = CF_{pv, indirect\_watt} \times Capacity_{system}

.. math::

   C_{land} = CF_{land} \times A_{land}

The sales tax component of the capital cost is calculated as follows:

.. math::

   C_{sales\_tax} = C_{direct} \times frac_{direct,CC\_sales\_tax} \times frac_{sales\_tax}



The operating costs include fixed and variable operating costs. The fixed operating costs includes the PV and battery fixed operating costs
and the battery replacement cost. The variable operating cost includes the PV variable operating cost.


.. math::

   C_{fixed\_operating} = C_{pv, fixed\_operating} + C_{battery, fixed\_operating} + C_{battery,replacement}


Where:

.. math::

   C_{pv, fixed\_operating} = CF_{pv, fixed\_operating} \times Capacity_{system}

.. math::

   C_{battery, fixed\_operating} = CF_{battery, fixed\_operating} \times P_{battery} \times h_{storage}


.. math::

   P_{battery\_replacement} = \frac{C_{battery\_replacement} \times P_{battery} \times h_{storage}} {Frequency_{battery\_replacement}}

.. math::

   C_{variable\_operating} = CF_{variable-operating} \times E_{annual}



The cost components are defined as follows:

.. csv-table::
   :header: "Cost Component","Symbol", "Value", "Units", "Description"

   "Cost per Watt", ":math:`CF_{pv, watt}`","0.34", ":math:`\text{\$/W}`", "Cost per watt for solar module"
   "Cost per Other Watt", ":math:`CF_{pv, other\_watt}`", "0.62", ":math:`\text{\$/W}`", "Cost per watt for balance of system equipment, installation labor, and margin/overhead"
   "Cost per Inverter Watt", ":math:`CF_{inverter\_watt}`", "0.03", ":math:`\text{\$/W}`", "Cost per watt for inverter capacity"
   "Cost per Indirect Watt", ":math:`CF_{pv, indirect\_watt}`", "0.05", ":math:`\text{\$/W}`", "Cost per watt for permitting, environmental studies, engineering, land prep, and grid interconnection"
   "Cost per Land Area", ":math:`CF_{land}`", "0", ":math:`\text{\$/acre}`", "Cost per acre of land required in the costing package"
   "Fraction of Capital Cost Subject to Sales Tax", ":math:`frac_{direct,CC\_sales\_tax}`", "1", "", "Fraction of direct capital cost subject to sales tax"
   "Sales Tax", ":math:`frac_{sales\_tax}`", "", "", "Sales tax rate in the costing package"
   "Cost per kW of Battery Power", ":math:`CF_{battery, kw}`", "233", ":math:`\text{\$/kW}`", "Cost per kW of battery power"
   "Cost per kWh of Battery Capacity", ":math:`CF_{battery, kwh}`", "252", ":math:`\text{\$/kWh}`", "Cost per kWh of battery capacity"
   "Fixed Operating Cost by PV Capacity", ":math:`CF_{battery, fixed\_operating}`", "31", ":math:`\text{\$/kW}`", "Fixed operating cost of PV system per kW generated"
   "Fixed Operating Cost by Battery Capacity", ":math:`CF_{pv, fixed\_operating}`", "7.25", ":math:`\text{\$/kWh}`", "Fixed operating cost per kWh of battery capacity"
   "Battery Replacement Cost", ":math:`C_{battery\_replacement}`", "252", ":math:`\text{\$/kWh}`", "Cost per kWh of battery capacity for battery replacement"
   "Battery Replacement Frequency", ":math:`Frequency_{battery\_replacement}`", "20", ":math:`\text{years}`", "Frequency of battery replacement"
   "Variable Operating Cost per Generation", ":math:`CF_{variable-operating}`", "0", ":math:`\text{\$/MWh}`", "Annual operating cost of PV system per MWh generated"
   
   

References
----------

* Blair, N.; Dobos, A.; Freeman, J.; Neises, T.; Wagner, M.; Ferguson, T.; Gilman, P.; Janzou, S. (2014). System Advisor Model™, SAM™ 2014.1.14: General Description. NREL/TP-6A20-61019. National Renewable Energy Laboratory. Golden, CO. Accessed May 23, 2025. www.nrel.gov/docs/fy14osti/61019.pdf . 
* System Advisor Model™ Version 2025.4.16 (SAM™ 2025.4.16). National Renewable Energy Laboratory. Golden, CO. Accessed May 23, 2025. https://https://sam.nrel.gov .
